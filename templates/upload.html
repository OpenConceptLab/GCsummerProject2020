<!DOCType html>
<html>

<head>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='main.css') }}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <title>
        CSV and JSON File Loader
    </title>
    <script type="text/javascript">
        $(function (){
            $.ajax({
                type: "GET",
                beforeSend: function(request) {
                request.setRequestHeader("Authorization", "Token hZrdvmAT7FvHXSLUqcz2WAH4GTm5sj");
            },
                url: "https://api.qa.openconceptlab.org/manage/bulkimport/?task=6b10dcb6-462e-478b-b210-ec5dc11a55e2-vinishad~default&result=summary",
                success:function(result, status, xhr) {
                alert(result)
                var response = (xhr.getResponseHeader("content-type"))
                    if (response.indexOf('text/html') > -1){
                        $("#stat").html(result);
                        $("#changer").hide()
                    }
                    else {
                        $("#changer").html("{ state: " + result["state"] + " , task: "  + result["task"] + " }");
                        }
                        $("#stat").hide()   
                    }
                    
            });
        });
        

        $("form#files").submit(function(){
            var formData = new FormData($(file)[0]);
            $.ajax({
                url: "http://api.qa.openconceptlab.org/manage/bulkimport/",
                type: 'POST',
                data: formData,
                async: false,
                beforeSend: function(request) {
                request.setRequestHeader("Authorization", "Token hZrdvmAT7FvHXSLUqcz2WAH4GTm5sj");
                },
                success: function (data) {
                alert(data)
            },
                cache: false,
                contentType: false,
                processData: false
            });
            return false;
        });
    </script>

</head>

<body>
   <div class="container">
        <div class="row">
            <div class="col">

                <h1>Upload CSV or JSON File</h1>

                <form id="files" action="/upload" method="POST" enctype="multipart/form-data">
                    <p> Upload a CSV or JSON File to the OCL Library </p><br>
                    <div class="form-group">
                        <div class="custom-file">
                            <label class="custom-file-label" for="file">Select File...</label>
                            <input type="file" class="custom-file-input" name="file" id="file" value="">   
                            <button type = "submit" class = "btn btn-primary" onclick="$('#loading').show();">Upload File</button>
                            
                        </div>
                    </div>
                </form>
                
                <form action="/upload" method="GET" enctype="multipart/form-data">
                    <button id="status" name="status">Get Update</button>
                </form>

                <div id="loading" style="display:none;">
                    <img class="col-sm-3 col-sm-offset-4" src="{{ url_for('static',filename='images/spinner.gif') }}" ng-show="loading">
                </div>
                    {% with messages = get_flashed_messages() %}
                      {% if messages %}
                        <ul class=flashes>
                        {% for message in messages %}
                          <li>{{ message }}</li>
                        {% endfor %}
                        </ul>
                      {% endif %}
                    {% endwith %}


                <h3>Status Updates</h3>    
                <div id="changer"> Status: </div>
                <div id="stat"> msg </div>


                
            </div>
        </div>
    </div>
    

</body>
</html>